âœ… 3ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ
Athena ã®ã‚¯ã‚¨ãƒªã‚¨ãƒ‡ã‚£ã‚¿ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š

sql
ã‚³ãƒ”ãƒ¼ã™ã‚‹
ç·¨é›†ã™ã‚‹
CREATE DATABASE tkkk_pj_logdb_sasaki
COMMENT 'ãƒ­ã‚°åˆ†æç”¨DB';
ğŸ‘‰ å·¦å´ãƒ‘ãƒãƒ«ã®ã€Œãƒ‡ãƒ¼ã‚¿ã€ã§ DB ãŒä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª

âœ… 4ï¸âƒ£ Firehose ã®ãƒ­ã‚°ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
Athena ã®ã‚¯ã‚¨ãƒªã‚¨ãƒ‡ã‚£ã‚¿ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ä½œæˆï¼ˆå‡ºåŠ›å…ˆS3ãƒ‘ã‚¹ã¯å®Ÿéš›ã®ã‚‚ã®ã«ç½®ãæ›ãˆï¼‰ï¼š

sql
ã‚³ãƒ”ãƒ¼ã™ã‚‹
ç·¨é›†ã™ã‚‹
CREATE EXTERNAL TABLE IF NOT EXISTS tkkk_pj_logdb_sasaki.firehose_logs (
  message string
)
PARTITIONED BY (day string)
ROW FORMAT SERDE 'org.openx.data.jsonserde.JsonSerDe'
LOCATION 's3://ï¼œFirehoseå‡ºåŠ›å…ˆãƒã‚±ãƒƒãƒˆï¼/ï¼œãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼/'
TBLPROPERTIES (
  "projection.enabled" = "true",
  "projection.day.type" = "date",
  "projection.day.range" = "2024/01/01,NOW",
  "projection.day.format" = "yyyy/MM/dd",
  "projection.day.interval" = "1",
  "projection.day.interval.unit" = "DAYS",
  "storage.location.template" = "s3://ï¼œFirehoseå‡ºåŠ›å…ˆãƒã‚±ãƒƒãƒˆï¼/ï¼œãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼/${day}/"
);
âœ… 5ï¸âƒ£ S3 ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
S3 ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãªã®ã§ä»¥ä¸‹ä¾‹ï¼š

sql
ã‚³ãƒ”ãƒ¼ã™ã‚‹
ç·¨é›†ã™ã‚‹
CREATE EXTERNAL TABLE IF NOT EXISTS tkkk_pj_logdb_sasaki.s3_access_logs (
  bucket_owner string,
  bucket string,
  request_datetime string,
  remote_ip string,
  requester string,
  request_id string,
  operation string,
  key string,
  request_uri string,
  http_status string,
  error_code string,
  bytes_sent bigint,
  object_size bigint,
  total_time int,
  turn_around_time int,
  referrer string,
  user_agent string,
  version_id string
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.RegexSerDe'
WITH SERDEPROPERTIES (
  'input.regex' = '([^ ]*) ([^ ]*) \\[([^\\]]*)\\] ([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*) \"([^\"]*)\" ([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*) \"([^\"]*)\" \"([^\"]*)\" ([^ ]*)'
)
LOCATION 's3://ï¼œã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã®ãƒã‚±ãƒƒãƒˆåï¼/AWSLogs/ï¼œã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDï¼/S3AccessLog/'
TBLPROPERTIES (
  'projection.enabled' = 'false'
);
ğŸ‘‰ ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ã¯å®Ÿéš›ã®ã‚‚ã®ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

âœ… 6ï¸âƒ£ ã‚¯ã‚¨ãƒªå®Ÿè¡Œä¾‹
Firehose ãƒ­ã‚°ç¢ºèª
sql
ã‚³ãƒ”ãƒ¼ã™ã‚‹
ç·¨é›†ã™ã‚‹
SELECT * FROM tkkk_pj_logdb_sasaki.firehose_logs
WHERE day = '2024/07/01'
LIMIT 10;
S3 ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ç¢ºèª
sql
ã‚³ãƒ”ãƒ¼ã™ã‚‹
ç·¨é›†ã™ã‚‹
SELECT request_datetime, remote_ip, operation, key, http_status
FROM tkkk_pj_logdb_sasaki.s3_access_logs
WHERE key = 'testfile.txt'
LIMIT 10;
ğŸ’¡ è£œè¶³
ã‚¯ã‚¨ãƒªã¯æ—¥ä»˜ãƒ»ã‚­ãƒ¼ãƒ»IP ãªã©ã§çµã‚‹ã¨ã‚³ã‚¹ãƒˆå‰Šæ¸›ã«ãªã‚Šã¾ã™ã€‚

ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³æŠ•å½±ï¼ˆFirehose ã®å ´åˆï¼‰ã¯æ—¥ä»˜ã«å¿œã˜ãŸãƒ•ã‚©ãƒ«ãƒ€éšå±¤ãŒå¿…è¦ã€‚

Athena ã®çµæœã¯æŒ‡å®šã® S3 ã«ä¿å­˜ã€ç¢ºèªå¯èƒ½ã€‚

ğŸŒŸ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
ã‚‚ã—ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ã‚„æ­£è¦è¡¨ç¾ãŒä¸æ˜ãªã‚‰ã€å®Ÿéš›ã® S3 ãƒ­ã‚°ã®ãƒ‘ã‚¹ã‚„ã‚µãƒ³ãƒ—ãƒ«ãƒ­ã‚°ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚
æ­£ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã«ã—ã¦æœ€é©ãªã‚¯ã‚¨ãƒªã‚’ä½œã‚Šã¾ã™ã€‚

å¿…è¦ãªã‚‰ã‚¯ã‚¨ãƒªé›†ã‚„ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ™ãƒ¼ã‚¹ã®æ‰‹é †ã‚‚ä½œæˆã—ã¾ã™ï¼
ã€Œã“ã‚Œã‚’ã‚‚ã£ã¨è©³ã—ãï¼ã€ã¨ã„ã†éƒ¨åˆ†ãŒã‚ã‚Œã°é æ…®ãªãè¨€ã£ã¦ãã ã•ã„ã€‚
