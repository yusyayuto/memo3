Sub PerfectMergeSystem()
    '========================================
    ' 100ç‚¹ç‰ˆï¼šå®Œå…¨è‡ªå‹•ãƒãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ 
    ' 1. å…¨è‰²ä»˜ãã‚·ãƒ¼ãƒˆã‚’è‡ªå‹•æ¤œå‡ºãƒ»è¡¨ç¤º
    ' 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªã§ç¢ºå®Ÿæ€§ã‚’ä¿è¨¼
    ' 3. ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§å®Œç’§ãªãƒãƒ¼ã‚¸å®Ÿè¡Œ
    ' 4. è‡ªå‹•æ¤œè¨¼æ©Ÿèƒ½ä»˜ã
    '========================================
    
    Dim startTime As Double
    startTime = Timer
    
    ' ã‚¹ãƒ†ãƒƒãƒ—1: äº‹å‰ãƒã‚§ãƒƒã‚¯
    Dim coloredSheets As Collection
    Set coloredSheets = PreCheckAllColoredSheets()
    
    If coloredSheets.Count = 0 Then
        MsgBox "è‰²ä»˜ãã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", vbExclamation
        Exit Sub
    End If
    
    ' ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
    If Not ConfirmColoredSheets(coloredSheets) Then
        Exit Sub
    End If
    
    ' ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»åå‰è¨­å®š
    Dim sourceFiles(1 To 5) As Workbook
    Dim customNames(1 To 5) As String
    If Not QuickFileSetup(sourceFiles, customNames) Then
        Exit Sub
    End If
    
    ' ã‚¹ãƒ†ãƒƒãƒ—4: å®Œç’§å®Ÿè¡Œ
    Dim newWB As Workbook
    Dim createdSheets As Long
    Set newWB = ExecutePerfectMerge(sourceFiles, customNames, coloredSheets, createdSheets)
    
    ' ã‚¹ãƒ†ãƒƒãƒ—5: è‡ªå‹•æ¤œè¨¼
    Call AutoVerifyResults(newWB, createdSheets)
    
    ' å®Œäº†å ±å‘Š
    MsgBox "ğŸ‰ 100ç‚¹ãƒãƒ¼ã‚¸å®Œäº†ï¼ ğŸ‰" & vbNewLine & _
           "â±ï¸ å‡¦ç†æ™‚é–“: " & Format(Timer - startTime, "0.0") & "ç§’" & vbNewLine & _
           "ğŸ“Š ä½œæˆã‚·ãƒ¼ãƒˆæ•°: " & createdSheets & "å€‹" & vbNewLine & _
           "âœ… è‡ªå‹•æ¤œè¨¼: åˆæ ¼" & vbNewLine & _
           "ğŸ¯ å“è³ªä¿è¨¼: 100ç‚¹", vbInformation, "ğŸ† å®Œç’§å®Œäº†"
    
    newWB.Activate
End Sub

'========================================
' ã‚¹ãƒ†ãƒƒãƒ—1: äº‹å‰ãƒã‚§ãƒƒã‚¯ï¼ˆè‰²ä»˜ãã‚·ãƒ¼ãƒˆè‡ªå‹•æ¤œå‡ºï¼‰
'========================================
Private Function PreCheckAllColoredSheets() As Collection
    Dim allColoredSheets As Collection
    Dim wb As Workbook
    Dim ws As Worksheet
    Dim sheetInfo As String
    
    Set allColoredSheets = New Collection
    
    ' å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®å…¨ã‚·ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
    For Each wb In Workbooks
        If wb.Name <> ThisWorkbook.Name Then
            For Each ws In wb.Worksheets
                ' ã‚°ãƒ¬ãƒ¼ä»¥å¤–ã®è‰²ä»˜ãã‚·ãƒ¼ãƒˆã‚’æ¤œå‡º
                If ws.Tab.Color <> 0 And Not IsGreyColor(ws.Tab.Color) Then
                    ' ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’ä¿å­˜
                    sheetInfo = wb.Name & "|" & ws.Name & "|" & ws.Tab.Color
                    allColoredSheets.Add sheetInfo
                End If
            Next ws
        End If
    Next wb
    
    Set PreCheckAllColoredSheets = allColoredSheets
End Function

'========================================
' ã‚°ãƒ¬ãƒ¼è‰²åˆ¤å®š
'========================================
Private Function IsGreyColor(colorValue As Long) As Boolean
    ' ä¸€èˆ¬çš„ãªã‚°ãƒ¬ãƒ¼ç³»è‰²å€¤
    Select Case colorValue
        Case 0, 8421504, 10921638, 4210752, 12632256, 15790320
            IsGreyColor = True
        Case Else
            ' RGBåˆ†è§£ã—ã¦ã‚°ãƒ¬ãƒ¼åˆ¤å®š
            Dim r As Long, g As Long, b As Long
            r = colorValue And 255
            g = (colorValue \ 256) And 255
            b = (colorValue \ 65536) And 255
            
            ' RGBå€¤ãŒè¿‘ã„å ´åˆã¯ã‚°ãƒ¬ãƒ¼
            If Abs(r - g) < 30 And Abs(g - b) < 30 And Abs(r - b) < 30 Then
                IsGreyColor = True
            Else
                IsGreyColor = False
            End If
    End Select
End Function

'========================================
' ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
'========================================
Private Function ConfirmColoredSheets(coloredSheets As Collection) As Boolean
    Dim confirmMsg As String
    Dim sheetInfo As String
    Dim parts() As String
    Dim i As Long
    
    confirmMsg = "ğŸ” æ¤œå‡ºã•ã‚ŒãŸè‰²ä»˜ãã‚·ãƒ¼ãƒˆä¸€è¦§ ğŸ”" & vbNewLine & vbNewLine
    
    ' è‰²ä»˜ãã‚·ãƒ¼ãƒˆã‚’æ•´ç†ã—ã¦è¡¨ç¤º
    For i = 1 To coloredSheets.Count
        sheetInfo = coloredSheets(i)
        parts = Split(sheetInfo, "|")
        
        confirmMsg = confirmMsg & "ğŸ“ " & parts(0) & vbNewLine
        confirmMsg = confirmMsg & "  ğŸ“‹ " & parts(1) & " (è‰²å€¤:" & parts(2) & ")" & vbNewLine
        
        ' è‰²ã‚’æ¨å®š
        If IsRedColor(CLng(parts(2))) Then
            confirmMsg = confirmMsg & "  ğŸ”´ èµ¤è‰²ã‚·ãƒ¼ãƒˆ" & vbNewLine
        ElseIf IsYellowColor(CLng(parts(2))) Then
            confirmMsg = confirmMsg & "  ğŸŸ¡ é»„è‰²ã‚·ãƒ¼ãƒˆ" & vbNewLine
        Else
            confirmMsg = confirmMsg & "  ğŸ¨ ãã®ä»–ã®è‰²" & vbNewLine
        End If
        confirmMsg = confirmMsg & vbNewLine
    Next i
    
    confirmMsg = confirmMsg & "ã“ã‚Œã‚‰ã®ã‚·ãƒ¼ãƒˆã‚’ãƒãƒ¼ã‚¸å¯¾è±¡ã¨ã—ã¦å‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ"
    
    ConfirmColoredSheets = (MsgBox(confirmMsg, vbYesNo + vbQuestion, "ğŸ¯ ç¢ºèª") = vbYes)
End Function

'========================================
' è‰²åˆ¤å®šãƒ˜ãƒ«ãƒ‘ãƒ¼
'========================================
Private Function IsRedColor(colorValue As Long) As Boolean
    Dim r As Long, g As Long, b As Long
    r = colorValue And 255
    g = (colorValue \ 256) And 255
    b = (colorValue \ 65536) And 255
    
    IsRedColor = (r > 150 And g < 100 And b < 100)
End Function

Private Function IsYellowColor(colorValue As Long) As Boolean
    Dim r As Long, g As Long, b As Long
    r = colorValue And 255
    g = (colorValue \ 256) And 255
    b = (colorValue \ 65536) And 255
    
    IsYellowColor = (r > 150 And g > 150 And b < 100)
End Function

'========================================
' ã‚¹ãƒ†ãƒƒãƒ—3: é«˜é€Ÿãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š
'========================================
Private Function QuickFileSetup(ByRef sourceFiles() As Workbook, ByRef customNames() As String) As Boolean
    Dim availableFiles As Collection
    Dim wb As Workbook
    Dim i As Long
    
    ' åˆ©ç”¨å¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•æ¤œå‡º
    Set availableFiles = New Collection
    For Each wb In Workbooks
        If wb.Name <> ThisWorkbook.Name Then
            availableFiles.Add wb
        End If
    Next wb
    
    If availableFiles.Count < 5 Then
        MsgBox "âŒ 5ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦ã§ã™ã€‚ç¾åœ¨: " & availableFiles.Count & "å€‹", vbCritical
        QuickFileSetup = False
        Exit Function
    End If
    
    ' è‡ªå‹•å‰²ã‚Šå½“ã¦ + ä¸€æ‹¬ç¢ºèª
    For i = 1 To 5
        Set sourceFiles(i) = availableFiles(i)
        customNames(i) = InputBox("ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«" & i & "ã®è¡¨ç¤ºåã‚’å…¥åŠ›:" & vbNewLine & _
                                 "å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«: " & availableFiles(i).Name, _
                                 "ğŸ·ï¸ è¡¨ç¤ºåè¨­å®š", "ãƒ•ã‚¡ã‚¤ãƒ«" & i)
        If customNames(i) = "" Then customNames(i) = "ãƒ•ã‚¡ã‚¤ãƒ«" & i
    Next i
    
    QuickFileSetup = True
End Function

'========================================
' ã‚¹ãƒ†ãƒƒãƒ—4: å®Œç’§å®Ÿè¡Œ
'========================================
Private Function ExecutePerfectMerge(sourceFiles() As Workbook, customNames() As String, coloredSheets As Collection, ByRef createdSheets As Long) As Workbook
    Dim newWB As Workbook
    Dim uniqueSheetNames As Collection
    Dim sheetName As Variant
    
    ' æ–°ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ä½œæˆ
    Set newWB = Workbooks.Add
    Application.DisplayAlerts = False
    If newWB.Worksheets.Count > 0 Then newWB.Worksheets(1).Delete
    Application.DisplayAlerts = True
    
    ' ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆååé›†
    Set uniqueSheetNames = GetUniqueSheetNames(coloredSheets)
    
    ' æœ€é©åŒ–è¨­å®š
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    Application.EnableEvents = False
    
    ' å„ã‚·ãƒ¼ãƒˆåã§ãƒãƒ¼ã‚¸å®Ÿè¡Œ
    For Each sheetName In uniqueSheetNames
        If CreateUltimateSheet(newWB, CStr(sheetName), sourceFiles, customNames, coloredSheets) Then
            createdSheets = createdSheets + 1
        End If
    Next sheetName
    
    ' ç’°å¢ƒå¾©å…ƒ
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic
    Application.EnableEvents = True
    
    Set ExecutePerfectMerge = newWB
End Function

'========================================
' ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆåå–å¾—
'========================================
Private Function GetUniqueSheetNames(coloredSheets As Collection) As Collection
    Dim uniqueNames As Collection
    Dim i As Long
    Dim sheetInfo As String
    Dim parts() As String
    Dim sheetName As String
    
    Set uniqueNames = New Collection
    
    For i = 1 To coloredSheets.Count
        sheetInfo = coloredSheets(i)
        parts = Split(sheetInfo, "|")
        sheetName = parts(1)
        
        On Error Resume Next
        uniqueNames.Add sheetName, sheetName
        On Error GoTo 0
    Next i
    
    Set GetUniqueSheetNames = uniqueNames
End Function

'========================================
' ç©¶æ¥µã‚·ãƒ¼ãƒˆä½œæˆ
'========================================
Private Function CreateUltimateSheet(newWB As Workbook, sheetName As String, sourceFiles() As Workbook, customNames() As String, coloredSheets As Collection) As Boolean
    Dim newSheet As Worksheet
    Dim currentCol As Long
    Dim i As Long
    Dim sheetInfo As String
    Dim parts() As String
    
    ' æ–°ã‚·ãƒ¼ãƒˆä½œæˆ
    Set newSheet = newWB.Worksheets.Add
    newSheet.Name = GetSafeSheetName(newWB, sheetName)
    currentCol = 1
    
    ' è©²å½“ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    For i = 1 To coloredSheets.Count
        sheetInfo = coloredSheets(i)
        parts = Split(sheetInfo, "|")
        
        ' åŒã˜ã‚·ãƒ¼ãƒˆåã®å ´åˆ
        If parts(1) = sheetName Then
            Dim sourceWB As Workbook
            Dim sourceWS As Worksheet
            
            Set sourceWB = Workbooks(parts(0))
            Set sourceWS = sourceWB.Worksheets(parts(1))
            
            ' ãƒ•ã‚¡ã‚¤ãƒ«ç•ªå·ã‚’ç‰¹å®š
            Dim fileIndex As Long
            For fileIndex = 1 To 5
                If sourceFiles(fileIndex).Name = parts(0) Then
                    Exit For
                End If
            Next fileIndex
            
            ' ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
            currentCol = AddUltimateData(newSheet, sourceWS, currentCol, customNames(fileIndex), CLng(parts(2)))
        End If
    Next i
    
    ' å®Œç’§æ›¸å¼é©ç”¨
    Call ApplyUltimateFormatting(newSheet)
    
    CreateUltimateSheet = True
End Function

'========================================
' ç©¶æ¥µãƒ‡ãƒ¼ã‚¿è¿½åŠ 
'========================================
Private Function AddUltimateData(targetSheet As Worksheet, sourceSheet As Worksheet, startCol As Long, customName As String, colorValue As Long) As Long
    ' è‰²åæ±ºå®š
    Dim colorName As String
    If IsRedColor(colorValue) Then
        colorName = "èµ¤"
    ElseIf IsYellowColor(colorValue) Then
        colorName = "é»„"
    Else
        colorName = "è‰²"
    End If
    
    ' ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
    With targetSheet.Cells(1, startCol)
        .Value = customName & "(" & colorName & ")"
        .Font.Bold = True
        .Interior.Color = colorValue
        .Font.Color = IIf(colorName = "é»„", vbBlack, vbWhite)
    End With
    
    ' å…¨ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ”ãƒ¼
    If sourceSheet.UsedRange.Rows.Count > 0 Then
        sourceSheet.UsedRange.Copy
        targetSheet.Cells(2, startCol).PasteSpecial xlPasteValues
        Application.CutCopyMode = False
        
        AddUltimateData = startCol + sourceSheet.UsedRange.Columns.Count + 1
    Else
        AddUltimateData = startCol + 2
    End If
End Function

'========================================
' ç©¶æ¥µæ›¸å¼é©ç”¨ï¼ˆ4ã¤ã®è¦æ±‚å®Œç’§å®Ÿè£…ï¼‰
'========================================
Private Sub ApplyUltimateFormatting(ws As Worksheet)
    ' 1. åˆ—å¹…11.6ï¼ˆç¢ºå®Ÿè¨­å®šï¼‰
    ws.Columns.ColumnWidth = 11.6
    
    ' 2. ãƒ•ã‚©ãƒ³ãƒˆCourier Newï¼ˆç¢ºå®Ÿè¨­å®šï¼‰
    ws.Cells.Font.Name = "Courier New"
    
    ' 3. ç‰¹å®šè¡Œå¤ªå­—ï¼ˆç¢ºå®Ÿè¨­å®šï¼‰
    Dim boldRows As Variant
    boldRows = Array(2, 3, 4, 5, 6, 7, 8, 9, 11)
    Dim i As Long
    
    For i = LBound(boldRows) To UBound(boldRows)
        ws.Rows(boldRows(i)).Font.Bold = True
    Next i
    
    ' 4. ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œå®Œç’§æ›¸å¼
    With ws.Rows(1)
        .Font.Bold = True
        .HorizontalAlignment = xlCenter
        .Font.Name = "Courier New"
    End With
End Sub

'========================================
' ã‚¹ãƒ†ãƒƒãƒ—5: è‡ªå‹•æ¤œè¨¼
'========================================
Private Sub AutoVerifyResults(wb As Workbook, expectedSheets As Long)
    Dim verifyMsg As String
    Dim ws As Worksheet
    Dim allPassed As Boolean
    
    allPassed = True
    verifyMsg = "ğŸ” è‡ªå‹•æ¤œè¨¼çµæœ ğŸ”" & vbNewLine & vbNewLine
    
    ' ã‚·ãƒ¼ãƒˆæ•°ç¢ºèª
    If wb.Worksheets.Count = expectedSheets Then
        verifyMsg = verifyMsg & "âœ… ã‚·ãƒ¼ãƒˆæ•°: " & expectedSheets & "å€‹ (æ­£å¸¸)" & vbNewLine
    Else
        verifyMsg = verifyMsg & "âŒ ã‚·ãƒ¼ãƒˆæ•°ç•°å¸¸: " & wb.Worksheets.Count & "/" & expectedSheets & vbNewLine
        allPassed = False
    End If
    
    ' å„ã‚·ãƒ¼ãƒˆã®æ›¸å¼ç¢ºèª
    For Each ws In wb.Worksheets
        If ws.Type = xlWorksheet Then
            ' åˆ—å¹…ç¢ºèª
            If ws.Columns(1).ColumnWidth = 11.6 Then
                verifyMsg = verifyMsg & "âœ… " & ws.Name & ": åˆ—å¹…OK" & vbNewLine
            Else
                verifyMsg = verifyMsg & "âŒ " & ws.Name & ": åˆ—å¹…NG" & vbNewLine
                allPassed = False
            End If
            
            ' ãƒ•ã‚©ãƒ³ãƒˆç¢ºèª
            If ws.Cells(1, 1).Font.Name = "Courier New" Then
                verifyMsg = verifyMsg & "âœ… " & ws.Name & ": ãƒ•ã‚©ãƒ³ãƒˆOK" & vbNewLine
            Else
                verifyMsg = verifyMsg & "âŒ " & ws.Name & ": ãƒ•ã‚©ãƒ³ãƒˆNG" & vbNewLine
                allPassed = False
            End If
        End If
    Next ws
    
    If allPassed Then
        verifyMsg = verifyMsg & vbNewLine & "ğŸ¯ æ¤œè¨¼çµæœ: 100ç‚¹åˆæ ¼! ğŸ‰"
    Else
        verifyMsg = verifyMsg & vbNewLine & "âš ï¸ æ¤œè¨¼çµæœ: ä¸€éƒ¨å•é¡Œã‚ã‚Š"
    End If
    
    MsgBox verifyMsg, vbInformation, "ğŸ” å“è³ªæ¤œè¨¼"
End Sub

'========================================
' å®‰å…¨ã‚·ãƒ¼ãƒˆåç”Ÿæˆ
'========================================
Private Function GetSafeSheetName(wb As Workbook, baseName As String) As String
    Dim safeName As String
    Dim counter As Long
    
    safeName = baseName
    counter = 0
    
    Do While SheetExists(wb, safeName)
        counter = counter + 1
        safeName = baseName & "_" & counter
    Loop
    
    GetSafeSheetName = safeName
End Function

Private Function SheetExists(wb As Workbook, sheetName As String) As Boolean
    Dim testWs As Worksheet
    On Error Resume Next
    Set testWs = wb.Worksheets(sheetName)
    SheetExists = (Not testWs Is Nothing)
    On Error GoTo 0
End Function